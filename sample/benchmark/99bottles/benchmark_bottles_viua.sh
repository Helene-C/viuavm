#!/usr/bin/env bash

set -e

if [[ $VIUA_BENCH_KERNEL == '' ]]; then
    VIUA_BENCH_KERNEL=viua-vm
fi
if [[ $VIUA_BENCH_SCHED_COUNTS == '' ]]; then
    VIUA_BENCH_SCHED_COUNTS='1 2 4 8'
fi
if [[ $VIUA_BENCH_ITERATIONS == '' ]]; then
    VIUA_BENCH_ITERATIONS=4
fi

AVAILABLE_CPUS=$(cat /proc/cpuinfo | grep -P '^processor\t*:' | wc -l)

HELP="VIUA VM BECHMARKS

    Viua VM beer bottles benchmark

    This benchmark tests Viua VM multiprocessing implementation by launching many processes, and
    reporting how fast the program completed.


LAUNCHING

        $0 <number-of-bottles>

    Examples

        $0 65536
        $0 8192
        $0 1024 2048 4096   # to run multiple benchmarks


BENCHMARK DESCRIPTION

    N+2 virtual processes are launched:

        - 1 main process launching the N \"worker\" processes
        - 1 printer process that prints messages generated by \"worker\" processes to standard
          output
        - N \"worker\" processes generating \"... bottles of beer on the wall\" messages

    Main process (M) launches the printer process (P) and worker processes (W).

    Worker processes (W) generate \"bottles of beer on the wall\" messages and
    send them to printer process (P).

    Printer process (P) receives messages from worker processes (W) and
    prints them to standard output.


CONFIGURATION

    Bechmark is run for different counts of VP schedulers: $VIUA_BENCH_SCHED_COUNTS
    Each VPS count is tested $VIUA_BENCH_ITERATIONS times.


GATHERED SYSTEM INFORMATION

    Benchmarked Viua VM kernel: $VIUA_BENCH_KERNEL
    Viua VM kernel info:        `$VIUA_BENCH_KERNEL --info`
    Available CPU cores:        $AVAILABLE_CPUS
"

BOTTLE_COUNTS=$1
if [[ $BOTTLE_COUNTS == '' ]]; then
    echo "error: no bottles"
    echo "note: use --help to display usage note"
    exit 1
fi

function usage() {
    echo -n "$HELP"
}

if [[ $BOTTLES == '--help' ]]; then
    usage
    exit 0
fi

echo "[vm]
    kernel = $VIUA_BENCH_KERNEL
    info = $($VIUA_BENCH_KERNEL --info)

[hardware \"cpu\"]
    model = $(cat /proc/cpuinfo | grep 'model name' | sort | uniq | sed 's/^model name\t*: *//')
    cores = $AVAILABLE_CPUS

[benchmark]
    sched_counts = $VIUA_BENCH_SCHED_COUNTS
    iterations = $VIUA_BENCH_ITERATIONS
    bottles = $BOTTLE_COUNTS
"

for BOTTLES in $BOTTLE_COUNTS; do
    for SCHEDS in $VIUA_BENCH_SCHED_COUNTS; do
        echo "[run]"
        echo "    processes = $BOTTLES"
        echo "    schedulers = $SCHEDS"
        for I in $(seq $VIUA_BENCH_ITERATIONS); do
            VIUA_VP_SCHEDULERS=$SCHEDS /usr/bin/time -f "    iteration[$I] = wall(%E) kernel(%S) user(%U)" $VIUA_BENCH_KERNEL a.out $BOTTLES > /dev/null
        done
        echo ""
    done
done
